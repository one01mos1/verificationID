<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRZ Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: {
                        'subtle': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Base Styling */
        body {
            background-color: #fafafa; /* Zinc 50 */
            color: #18181b; /* Zinc 900 */
        }

        /* Scoped animations */
        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(59, 130, 246, 0.5); /* Blue 500 */
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            animation: scan 2.5s ease-in-out infinite;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Dot Loader */
        .dots-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }
        
        .dots-loader span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e4e4e7; /* Zinc 200 */
            animation: pulse-dot 1.4s infinite ease-in-out both;
        }
        
        .dots-loader span:nth-child(1) { animation-delay: -0.32s; background-color: #3b82f6; }
        .dots-loader span:nth-child(2) { animation-delay: -0.16s; background-color: #60a5fa; }
        .dots-loader span:nth-child(3) { background-color: #93c5fd; }
        
        @keyframes pulse-dot {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.6; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        /* Input styling overrides */
        input:read-only {
            background-color: #fafafa;
            color: #52525b;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-2xl mx-auto space-y-10">
        <!-- Header -->
        <div class="text-center space-y-2">
            <h1 class="text-3xl font-semibold tracking-tight text-zinc-900">Document Scanner</h1>
            <p class="text-zinc-500 text-sm font-medium">Capture MRZ data from passports and IDs</p>
        </div>

        <!-- Main Card -->
        <div class="bg-white rounded-3xl p-8 sm:p-10 shadow-card border border-zinc-100/50">
            
            <!-- Scanner Area -->
            <div id="scanner-ui" class="space-y-8 animate-fade-in">
                <!-- Camera Viewfinder -->
                <div class="relative rounded-2xl overflow-hidden bg-zinc-50 aspect-video ring-1 ring-zinc-100 shadow-inner group mx-auto">
                    <video id="video" class="w-full h-full object-cover transform scale-[1.01]" autoplay playsinline></video>
                    
                    <!-- Scan Animation -->
                    <div id="scan-animation" class="scan-line hidden pointer-events-none"></div>
                    
                    <!-- Scan Corners (Minimalist) -->
                    <div id="scan-corners" class="absolute inset-5 pointer-events-none hidden opacity-60 transition-opacity">
                        <div class="absolute top-0 left-0 w-6 h-6 border-l-2 border-t-2 border-white rounded-tl-lg"></div>
                        <div class="absolute top-0 right-0 w-6 h-6 border-r-2 border-t-2 border-white rounded-tr-lg"></div>
                        <div class="absolute bottom-0 left-0 w-6 h-6 border-l-2 border-b-2 border-white rounded-bl-lg"></div>
                        <div class="absolute bottom-0 right-0 w-6 h-6 border-r-2 border-b-2 border-white rounded-br-lg"></div>
                    </div>

                    <!-- Processing Particles Overlay Container -->
                    <div id="processing-particles" class="hidden absolute inset-0 pointer-events-none"></div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="capture" class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-3.5 text-sm font-medium text-white transition-all duration-200 bg-zinc-900 rounded-full hover:bg-zinc-800 hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-zinc-900 shadow-lg shadow-zinc-900/10">
                        <svg class="w-4 h-4 mr-2.5 opacity-90" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                        Scan Document
                    </button>
                    
                    <button id="uploadButton" class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-3.5 text-sm font-medium text-zinc-600 transition-all duration-200 bg-zinc-50 rounded-full hover:bg-zinc-100 hover:text-zinc-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-zinc-200">
                        <svg class="w-4 h-4 mr-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Upload Image
                    </button>
                    <input type="file" id="fileInput" class="hidden" accept="image/*">
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="hidden py-16 text-center animate-fade-in">
                <div class="dots-loader mb-6">
                    <span></span><span></span><span></span>
                </div>
                <h3 class="text-zinc-900 font-medium text-base mb-1">Analyzing Document</h3>
                <p class="text-zinc-400 text-xs tracking-wide uppercase">Please wait...</p>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden mt-6 bg-red-50 text-red-600 px-6 py-4 rounded-2xl border border-red-100 text-sm flex gap-4 items-center animate-slide-up" role="alert">
                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <span class="font-medium" id="error-text"></span>
            </div>

            <!-- Results Form -->
            <div id="form-container" class="hidden animate-slide-up space-y-8 pt-4">
                
                <!-- Success Indicator -->
                <div class="flex justify-center">
                    <span class="inline-flex items-center px-4 py-1.5 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-600 border border-emerald-100">
                        <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
                        Extraction Successful
                    </span>
                </div>

                <form id="mrz-form" class="space-y-6">
                    <div>
                        <label class="block text-xs font-semibold text-zinc-400 uppercase tracking-widest mb-2 pl-1">Document Number</label>
                        <input type="text" id="documentNumber" class="block w-full rounded-xl border-0 bg-zinc-50 py-3.5 px-4 text-zinc-900 shadow-sm ring-1 ring-inset ring-zinc-200 focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm sm:leading-6 transition-all" readonly>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-semibold text-zinc-400 uppercase tracking-widest mb-2 pl-1">Surname</label>
                            <input type="text" id="surname" class="block w-full rounded-xl border-0 bg-zinc-50 py-3.5 px-4 text-zinc-900 shadow-sm ring-1 ring-inset ring-zinc-200 focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm sm:leading-6 transition-all" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-zinc-400 uppercase tracking-widest mb-2 pl-1">Given Names</label>
                            <input type="text" id="firstName" class="block w-full rounded-xl border-0 bg-zinc-50 py-3.5 px-4 text-zinc-900 shadow-sm ring-1 ring-inset ring-zinc-200 focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm sm:leading-6 transition-all" readonly>
                        </div>
                    </div>

                    <!-- Hidden Middle Name (Preserved for logic but not shown in clean UI) -->
                    <div class="hidden">
                        <input type="text" id="middleName">
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-zinc-400 uppercase tracking-widest mb-2 pl-1">DOB</label>
                            <input type="text" id="dateOfBirth" class="block w-full rounded-xl border-0 bg-zinc-50 py-3.5 px-2 text-center text-zinc-900 shadow-sm ring-1 ring-inset ring-zinc-200 sm:text-sm transition-all" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-zinc-400 uppercase tracking-widest mb-2 pl-1">Expires</label>
                            <input type="text" id="expiryDate" class="block w-full rounded-xl border-0 bg-zinc-50 py-3.5 px-2 text-center text-zinc-900 shadow-sm ring-1 ring-inset ring-zinc-200 sm:text-sm transition-all" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-zinc-400 uppercase tracking-widest mb-2 pl-1">Sex</label>
                            <input type="text" id="sex" class="block w-full rounded-xl border-0 bg-zinc-50 py-3.5 px-2 text-center text-zinc-900 shadow-sm ring-1 ring-inset ring-zinc-200 sm:text-sm transition-all" readonly>
                        </div>
                    </div>

                    <div class="pt-8 flex flex-col sm:flex-row justify-center gap-3">
                         <button type="button" id="scan-again" class="inline-flex items-center justify-center rounded-full bg-zinc-900 px-8 py-3 text-sm font-semibold text-white shadow-sm hover:bg-zinc-800 transition-all focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-zinc-900 w-full sm:w-auto">
                            Scan Another
                        </button>
                        <button type="button" id="toggle-debug" class="inline-flex items-center justify-center rounded-full bg-white px-6 py-3 text-sm font-medium text-zinc-400 hover:text-zinc-600 hover:bg-zinc-50 transition-all w-full sm:w-auto">
                            Debug
                        </button>
                    </div>
                </form>
            </div>

            <!-- Technical Debug Info -->
            <div id="debug-info" class="hidden mt-8 pt-6 border-t border-zinc-100">
                <h4 class="text-xs font-bold text-zinc-400 uppercase mb-3">Debug Log</h4>
                <div class="bg-zinc-50 rounded-xl p-4 overflow-hidden">
                    <pre id="debug-text" class="text-[10px] text-zinc-500 font-mono whitespace-pre-wrap max-h-32 overflow-y-auto"></pre>
                </div>
            </div>

            <!-- Hidden Canvas for processing -->
            <canvas id="canvas" class="hidden"></canvas>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('capture');
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const formContainer = document.getElementById('form-container');
        const scannerUi = document.getElementById('scanner-ui');
        const scanAnimation = document.getElementById('scan-animation');
        // Removed scanOverlay reference as it was removed from HTML
        const scanCorners = document.getElementById('scan-corners');
        const processingParticles = document.getElementById('processing-particles');
        const scanAgainButton = document.getElementById('scan-again');
        const toggleDebugButton = document.getElementById('toggle-debug');
        const debugInfo = document.getElementById('debug-info');
        const debugText = document.getElementById('debug-text');
        const mrzForm = document.getElementById('mrz-form');

        let stream;
        let debugMode = false;

        // --- Enhanced Visual Effects (Simplified) ---

        function showScanningEffects() {
            scanAnimation.classList.remove('hidden');
            scanCorners.classList.remove('hidden');
            processingParticles.classList.remove('hidden');
        }

        function hideScanningEffects() {
            scanAnimation.classList.add('hidden');
            scanCorners.classList.add('hidden');
            processingParticles.classList.add('hidden');
        }

        function showProcessingText(message) {
            // Updated to be a nicer, centered pill overlay
            let overlay = document.getElementById('processing-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'processing-overlay';
                overlay.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20';
                overlay.innerHTML = `
                    <div class="bg-zinc-900/90 backdrop-blur-sm text-white px-6 py-3 rounded-full flex items-center gap-3 shadow-xl border border-white/10">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                        <span class="text-sm font-medium message-content">${message}</span>
                    </div>
                `;
                document.querySelector('#scanner-ui .relative').appendChild(overlay);
            } else {
                overlay.querySelector('.message-content').textContent = message;
            }
        }

        function hideProcessingText() {
            const overlay = document.getElementById('processing-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // --- Camera and UI Functions ---

        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                showError("Could not access the camera. Please grant permissions and ensure a camera is connected.");
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            loading.classList.add('hidden');
            scannerUi.classList.remove('hidden');
            formContainer.classList.add('hidden');
            hideScanningEffects();
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }
        
        function showLoading(isProcessing) {
            hideError();
            
            // Disable buttons
            captureButton.disabled = isProcessing;
            uploadButton.disabled = isProcessing;
            
            if (isProcessing) {
                showScanningEffects();
                showProcessingText("Analyzing Document...");
                // Add a slight opacity to the video to indicate processing focus
                video.classList.add('opacity-50');
            } else {
                hideScanningEffects();
                hideProcessingText();
                video.classList.remove('opacity-50');
                captureButton.disabled = false;
                uploadButton.disabled = false;
            }
        }

        function debugLog(message, data = null) {
            console.log(message, data);
            if (debugMode) {
                const timestamp = new Date().toLocaleTimeString();
                debugText.textContent += `[${timestamp}] ${message}\n`;
                if (data) {
                    debugText.textContent += JSON.stringify(data, null, 2) + '\n';
                }
                debugText.textContent += '\n';
                // Auto scroll to bottom
                debugText.scrollTop = debugText.scrollHeight;
            }
        }

        // --- Event Listeners ---

        captureButton.addEventListener('click', () => {
             if (!stream) {
                showError("Camera is not active. Please start the camera first.");
                return;
            }
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const compressedImage = compressImage(canvas);
            processImage(compressedImage);
        });
        
        uploadButton.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        canvas.getContext('2d').drawImage(img, 0, 0);
                        const compressedImage = compressImage(canvas);
                        processImage(compressedImage);
                    };
                    img.src = e.target.result;
                    if (stream) {
                        video.srcObject = null;
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        scanAgainButton.addEventListener('click', () => {
            mrzForm.reset();
            formContainer.classList.add('hidden');
            scannerUi.classList.remove('hidden');
            hideError();
            if (debugMode) {
                debugText.textContent = '';
            }
            startCamera();
        });

        toggleDebugButton.addEventListener('click', () => {
            debugMode = !debugMode;
            debugInfo.classList.toggle('hidden', !debugMode);
            toggleDebugButton.textContent = debugMode ? 'Hide Debug' : 'Debug';
            if (debugMode) {
                setTimeout(() => debugInfo.scrollIntoView({ behavior: 'smooth' }), 100);
            } else {
                debugText.textContent = '';
            }
        });

        // --- Image Compression Function ---
        
        function compressImage(canvas) {
            debugLog("Starting image compression...");
            
            const maxWidth = 1200;
            const maxHeight = 900;
            const maxSizeKB = 800; // Target under 800KB to be safe
            
            let { width, height } = canvas;
            
            // Resize if too large
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = width;
                tempCanvas.height = height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(canvas, 0, 0, width, height);
                canvas = tempCanvas;
                
                debugLog(`Resized image to: ${width}x${height}`);
            }
            
            // Try different quality levels
            for (let quality = 0.8; quality >= 0.3; quality -= 0.1) {
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                const sizeKB = Math.round((dataUrl.length * 3) / 4 / 1024);
                
                debugLog(`Quality ${quality}: ${sizeKB}KB`);
                
                if (sizeKB <= maxSizeKB) {
                    debugLog(`Final compressed size: ${sizeKB}KB at quality ${quality}`);
                    return dataUrl;
                }
            }
            
            // If still too large, use minimum quality
            const finalDataUrl = canvas.toDataURL('image/jpeg', 0.3);
            const finalSizeKB = Math.round((finalDataUrl.length * 3) / 4 / 1024);
            debugLog(`Final compressed size (min quality): ${finalSizeKB}KB`);
            
            return finalDataUrl;
        }

        // --- Core Logic: Image Processing and Parsing ---

        async function processImage(imageDataUrl) {
            debugLog("Starting image processing...");
            
            // Calculate and log image size
            const imageSizeKB = Math.round((imageDataUrl.length * 3) / 4 / 1024);
            debugLog(`Image size: ${imageSizeKB}KB`);
            
            // Transition to loading UI with blur
            showLoading(true);

            // Using OCR Space API (Using free tier key for demo)
            const apiKey = 'K82888938488957'; 
            const formData = new FormData();
            formData.append('base64Image', imageDataUrl);
            formData.append('apikey', apiKey);
            formData.append('OCREngine', 2);
            formData.append('detectOrientation', 'true');
            formData.append('scale', 'true');
            formData.append('isTable', 'true');
            formData.append('language', 'eng');

            try {
                showProcessingText("Connecting...");
                debugLog("Sending request to OCR service...");
                
                const response = await fetch('https://api.ocr.space/parse/image', { 
                    method: 'POST', 
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                showProcessingText("Reading Text...");
                const data = await response.json();
                debugLog("OCR Response received:", data);

                if (data.IsErroredOnProcessing) {
                    throw new Error(data.ErrorMessage.join('\n'));
                }
                
                if (!data.ParsedResults?.length) {
                    throw new Error("OCR service did not return any results.");
                }

                const ocrText = data.ParsedResults[0].ParsedText;
                debugLog("OCR Text extracted:", ocrText);

                showProcessingText("Extracting Data...");
                await new Promise(resolve => setTimeout(resolve, 500)); 
                
                const mrzData = parseMrz(ocrText);
                debugLog("Parsed MRZ data:", mrzData);

                if (Object.keys(mrzData).length === 0) {
                   showLoading(false);
                   showError("Could not find a valid MRZ. Please ensure the machine readable zone is clear and in frame.");
                } else {
                    showProcessingText("Complete");
                    await new Promise(resolve => setTimeout(resolve, 600)); 
                    populateForm(mrzData);
                    debugLog("Form populated successfully");
                }

            } catch (error) {
                console.error('Error processing image:', error);
                debugLog("Error processing image:", error.message);
                showLoading(false);
                showError(`Failed to process the image. ${error.message}`);
            }
        }

        function populateForm(data) {
            debugLog("Populating form with data:", data);
            
            showLoading(false);
            
            const names = (data.givenNames || '').split(' ').filter(name => name.length > 0);
            const firstName = names[0] || '';
            const middleName = names.slice(1).join(' ') || '';

            document.getElementById('documentNumber').value = data.documentNumber || '';
            document.getElementById('surname').value = data.surname || '';
            document.getElementById('firstName').value = firstName;
            document.getElementById('middleName').value = middleName;
            document.getElementById('dateOfBirth').value = data.dateOfBirth || '';
            document.getElementById('expiryDate').value = data.expiryDate || '';
            document.getElementById('sex').value = data.sex || '';
            
            // Switch UI views
            scannerUi.classList.add('hidden');
            formContainer.classList.remove('hidden');
            
            // Removed default success alert, using the built-in badge design now
            
            debugLog("Form displayed successfully");
        }

        function parseMrz(text) {
            debugLog("Parsing MRZ from text:", text);
            
            if (!text || typeof text !== 'string') {
                debugLog("Invalid input text");
                return {};
            }

            // Clean and split text into lines
            const lines = text.split(/[\r\n]+/)
                .map(line => line.replace(/[\s\r]/g, '').toUpperCase())
                .filter(line => line.length > 0);

            debugLog("Cleaned lines:", lines);

            const mrzRegex = /^[A-Z0-9<]+$/;

            // Try to find MRZ patterns more flexibly
            for (let i = 0; i < lines.length; i++) {
                const line1 = lines[i];
                debugLog(`Checking line ${i}: ${line1} (length: ${line1.length})`);

                // Check for TD3 Passport (2x44)
                if (line1.length >= 42 && line1.length <= 46 && line1.startsWith('P') && mrzRegex.test(line1)) {
                    debugLog("Potential TD3 passport line found");
                    if (i + 1 < lines.length) {
                        const line2 = lines[i+1];
                        debugLog(`Second line: ${line2} (length: ${line2.length})`);
                        if (line2.length >= 42 && line2.length <= 46 && mrzRegex.test(line2)) {
                            debugLog("Valid TD3 passport detected");
                            return parseTd3(line1.substring(0, 44), line2.substring(0, 44));
                        }
                    }
                }

                // Check for TD1 ID Card (3x30)
                if (line1.length >= 28 && line1.length <= 32 && 
                    (line1.startsWith('A') || line1.startsWith('C') || line1.startsWith('I')) && 
                    mrzRegex.test(line1)) {
                    debugLog("Potential TD1 ID card line found");
                    if (i + 2 < lines.length) {
                        const line2 = lines[i+1];
                        const line3 = lines[i+2];
                        debugLog(`Second line: ${line2} (length: ${line2.length})`);
                        debugLog(`Third line: ${line3} (length: ${line3.length})`);
                        if (line2.length >= 28 && line2.length <= 32 && mrzRegex.test(line2) && 
                            line3.length >= 28 && line3.length <= 32 && mrzRegex.test(line3)) {
                            debugLog("Valid TD1 ID card detected");
                            return parseIdCard3Line(
                                line1.substring(0, 30), 
                                line2.substring(0, 30), 
                                line3.substring(0, 30)
                            );
                        }
                    }
                }

                // Check for TD2 ID Card (2x36)
                if (line1.length >= 34 && line1.length <= 38 && 
                    (line1.startsWith('A') || line1.startsWith('C') || line1.startsWith('I')) && 
                    mrzRegex.test(line1)) {
                    debugLog("Potential TD2 ID card line found");
                    if (i + 1 < lines.length) {
                        const line2 = lines[i+1];
                        debugLog(`Second line: ${line2} (length: ${line2.length})`);
                        if (line2.length >= 34 && line2.length <= 38 && mrzRegex.test(line2)) {
                            debugLog("Valid TD2 ID card detected");
                            return parseIdCard2Line(
                                line1.substring(0, 36), 
                                line2.substring(0, 36)
                            );
                        }
                    }
                }
            }
            
            debugLog("No valid MRZ format found");
            return {}; // No valid format found
        }
        
        function parseTd3(line1, line2) {
            debugLog("Parsing TD3 passport", { line1, line2 });
            if (!line1 || !line2) return {};
            
            try {
                const nameParts = line1.substring(5, 44).split('<<').filter(part => part.length > 0);
                const result = {
                    documentType: line1.substring(0, 1),
                    issuingCountry: line1.substring(2, 5).replace(/</g, '').trim(),
                    surname: nameParts[0]?.replace(/</g, ' ').trim() || '',
                    givenNames: nameParts[1]?.replace(/</g, ' ').trim() || '',
                    documentNumber: line2.substring(0, 9).replace(/</g, '').trim(),
                    nationality: line2.substring(10, 13).replace(/</g, '').trim(),
                    dateOfBirth: formatDate(line2.substring(13, 19)),
                    sex: line2.substring(20, 21),
                    expiryDate: formatDate(line2.substring(21, 27), true),
                };
                debugLog("TD3 parsed result:", result);
                return result;
            } catch (error) {
                debugLog("Error parsing TD3:", error.message);
                return {};
            }
        }

        function parseIdCard3Line(line1, line2, line3) {
            debugLog("Parsing 3-line ID card", { line1, line2, line3 });
            if (!line1 || !line2 || !line3) return {};
            
            try {
                const nameParts = line3.split('<<').filter(part => part.length > 0);
                const result = {
                    documentType: line1.substring(0, 1),
                    issuingCountry: line1.substring(2, 5).replace(/</g, '').trim(),
                    documentNumber: line1.substring(5, 14).replace(/</g, '').trim(),
                    dateOfBirth: formatDate(line2.substring(0, 6)),
                    sex: line2.substring(7, 8),
                    expiryDate: formatDate(line2.substring(8, 14), true),
                    nationality: line2.substring(15, 18).replace(/</g, '').trim(),
                    surname: nameParts[0]?.replace(/</g, ' ').trim() || '',
                    givenNames: nameParts[1]?.replace(/</g, ' ').trim() || '',
                };
                debugLog("3-line ID card parsed result:", result);
                return result;
            } catch (error) {
                debugLog("Error parsing 3-line ID card:", error.message);
                return {};
            }
        }

        function parseIdCard2Line(line1, line2) {
            debugLog("Parsing 2-line ID card", { line1, line2 });
            if (!line1 || !line2) return {};
            
            try {
                const nameParts = line1.substring(5, 36).split('<<').filter(part => part.length > 0);
                const result = {
                    documentType: line1.substring(0, 2),
                    issuingCountry: line1.substring(2, 5).replace(/</g, '').trim(),
                    surname: nameParts[0]?.replace(/</g, ' ').trim() || '',
                    givenNames: nameParts[1]?.replace(/</g, ' ').trim() || '',
                    documentNumber: line2.substring(0, 12).replace(/</g, '').trim(),
                    dateOfBirth: formatDate(line2.substring(13, 19)),
                    sex: line2.substring(20, 21),
                    expiryDate: formatDate(line2.substring(21, 27), true),
                };
                debugLog("2-line ID card parsed result:", result);
                return result;
            } catch (error) {
                debugLog("Error parsing 2-line ID card:", error.message);
                return {};
            }
        }

        function formatDate(dateStr, isExpiry = false) {
            debugLog(`Formatting date: ${dateStr}, isExpiry: ${isExpiry}`);
            
            if (!dateStr || dateStr.length !== 6) {
                debugLog("Invalid date string length");
                return "";
            }
            
            const year = parseInt(dateStr.substring(0, 2), 10);
            const month = parseInt(dateStr.substring(2, 4), 10);
            const day = parseInt(dateStr.substring(4, 6), 10);
            
            if (isNaN(year) || isNaN(month) || isNaN(day) || 
                month < 1 || month > 12 || day < 1 || day > 31) {
                debugLog("Invalid date components");
                return "";
            }

            const currentYear = new Date().getFullYear();
            const currentYearLastTwoDigits = currentYear % 100;
            
            let fullYear;
            if (isExpiry) {
                // For expiry dates, assume future dates
                fullYear = year <= currentYearLastTwoDigits ? 2000 + year : 1900 + year;
                // If still in the past, add 100 years
                const testDate = new Date(fullYear, month - 1, day);
                if (testDate < new Date()) {
                    fullYear += 100;
                }
            } else {
                // For birth dates, assume past dates
                fullYear = year > currentYearLastTwoDigits ? 1900 + year : 2000 + year;
                // If in the future, subtract 100 years
                const testDate = new Date(fullYear, month - 1, day);
                if (testDate > new Date()) {
                    fullYear -= 100;
                }
            }
            
            const formattedDate = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${fullYear}`;
            debugLog(`Formatted date result: ${formattedDate}`);
            return formattedDate;
        }
        
        // Initialize
        debugLog("Application initialized");
        startCamera();
    });
    </script>
</body>
</html>
